<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/public/stylesheets/bs.css">
    <link rel="stylesheet" href="/public/stylesheets/styles.css">
    <link rel="stylesheet" href="/public/stylesheets/pygment_trac.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"> 
    <link rel="canonical" href="www.yangsailing.com/blog/">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <link rel="icon" type="image/x-icon"  href="/favicon.ico" />
    <title>blog | Romeo'blog</title>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head> 
  <body>
    <div class="wrapper">    
        <section>   
          <div id="title">
  <h1>
    
		  <a id="git-ic" href="https://github.com/492066199"><i class="fa fa-github"></i></a>	
    

    
      <a id="so-ic" href="http://stackoverflow.com/users/1231365/railsr"><i class="fa fa-stack-overflow"></i></a>
    
		
    <a id="sitename" href="">www.yangsailing.com</a>
  </h1>

  <!-- Add something about you in p tag-->
  <p>本博客长期专注软件开发基本功，Linux平台基础开源(nginx, redis, memcached)软件分析、研究，高级数据结构与算法详解，大数据(kafka，Samza，hadoop)相关原理剖析，欢迎不涩指点</p>
  <hr/>
  
  <span class="credits left">
  <a href="/blog">Blog</a> | 
  <a href="/archive">Archive</a> |
  <a href="/resume">Resume</a> |
  <a href="/projects">Projects</a> 
</span>

<span class="credits right">

</span> 
	 
</div>



      
          
<div class="post-header-home">
  <h1>
    <a href="/nginx">nginx源码分析2———基础数据结构六(ngx_hash_keys_arrays_t）</a>
  </h1>
  <p class="text-muted">11 Aug 2015 | <i class="fa fa-comment"></i> <a class="text-muted" href="/nginx/#disqus_thread"></a> | <i class="fa fa-tag"></i>
  
    
  
  
  <a class="text-muted" href="/tags/#nginx">nginx</a>,
  
  <a class="text-muted" href="/tags/#ngx_hash_keys_arrays_t）">ngx_hash_keys_arrays_t）</a>
  


 </p>

</div>
<div class="post-excerpt-home">
  <h3 id="section">相关介绍</h3>
<p><strong><em>在构建一个ngx_hash_wildcard_t的时候，需要对通配符的哪些key进行预处理。这个处理起来比较麻烦</em></strong>。而当有一组key，这些里面既有无通配符的
key，也有包含通配符的key的时候。我们就需要构建三个hash表，一个包含普通的key的hash表，一个包含前向通配符的hash表，一个包含后向通配符的hash
表（或者也可以把这三个hash表组合成一个ngx_hash_combined_t）。在这种情况下，为了让大家方便的构造这些hash表，nginx提供给了此辅助类型。有了
这个就可以清晰了解上一篇博文
###源码分析
####相关结构
ngx_hash_keys_arrays_t就是我们说的辅助结构，辅助我们更容易去构建<strong><em>ngx_hash_wildcard_t</em></strong>
<code>c
typedef struct {
    ngx_uint_t        hsize;
    ngx_pool_t       *pool;
    ngx_pool_t       *temp_pool;
    ngx_array_t       keys;
    ngx_array_t      *keys_hash;
    ngx_array_t       dns_wc_head;
    ngx_array_t      *dns_wc_head_hash;
    ngx_array_t       dns_wc_tail;
    ngx_array_t      *dns_wc_tail_hash;
} ngx_hash_keys_arrays_t;
</code>
<strong><em>hsize</em></strong>是我们将要构建的hash表的桶的个数
<strong><em>pool</em></strong> 构建hash表使用的pool
<strong><em>temp_pool</em></strong>在构建这个类型以及最终的三个hash表过程中可能用到临时pool
<strong><em>keys</em></strong>存放所有非通配符key的数组
<strong><em>keys_hash</em></strong>这是个二维数组，第一个维度代表的是bucket的编号，那么keys_hash[i]中存放的是所有的key算出来的hash值对hsize取模以后的值为i
的key
<strong><em>dns_wc_head</em></strong>放前向通配符key被处理完成以后的值
<strong><em>dns_wc_tail</em></strong>存放后向通配符key被处理完成以后的值
<strong><em>dns_wc_head_hash</em></strong>该值在调用的过程中用来保存和检测是否有冲突的前向通配符的key值，<strong><em>也就是是否有重复</em></strong>
<strong><em>dns_wc_tail_hash</em></strong>该值在调用的过程中用来保存和检测是否有冲突的后向通配符的key值，<strong><em>也就是是否有重复</em></strong>
####结构的初始化
```c
ngx_int_t
ngx_hash_keys_array_init(ngx_hash_keys_arrays_t *ha, ngx_uint_t type)
{
    ngx_uint_t  asize;
	//根据type来选择是大号桶的个数还是小号桶的个数
    if (type == NGX_HASH_SMALL) {
        asize = 4;
        ha-&gt;hsize = 107;
    } else {
        asize = NGX_HASH_LARGE_ASIZE;
        ha-&gt;hsize = NGX_HASH_LARGE_HSIZE;
    }</p>

<pre><code>//初始化非通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;keys, ha-&gt;temp_pool, asize, sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化头部有通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;dns_wc_head, ha-&gt;temp_pool, asize,sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化尾部有通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;dns_wc_tail, ha-&gt;temp_pool, asize, sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化二维数组keys_hash
ha-&gt;keys_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;keys_hash == NULL) {
    return NGX_ERROR;
}
//初始化头部通配符冲突检测
ha-&gt;dns_wc_head_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;dns_wc_head_hash == NULL) {
    return NGX_ERROR;
}
//初始化尾部通配符冲突检测
ha-&gt;dns_wc_tail_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;dns_wc_tail_hash == NULL) {
    return NGX_ERROR;
}
return NGX_OK; } ``` ***ngx_hash_keys_array_init***初始化操作。都是一系列分配内存操作。下面我们来看一看ngx_hash_add_key操作。 ```c ngx_int_t ngx_hash_add_key(ngx_hash_keys_arrays_t *ha, ngx_str_t *key, void *value,ngx_uint_t flags) {
size_t           len;
u_char          *p;
ngx_str_t       *name;
ngx_uint_t       i, k, n, skip, last;
ngx_array_t     *keys, *hwc;
ngx_hash_key_t  *hk;
</code></pre>


  <p class="text-left"><a href="/nginx">Continue Reading &rarr;</a></p>
</div>

<div class="post-header-home">
  <h1>
    <a href="/testtest">Test post</a>
  </h1>
  <p class="text-muted">30 Nov 2014 | <i class="fa fa-comment"></i> <a class="text-muted" href="/testtest/#disqus_thread"></a> | <i class="fa fa-tag"></i>
  
    
  
  
  <a class="text-muted" href="/tags/#test_tag">test_tag</a>
  


 </p>

</div>
<div class="post-excerpt-home">
  <h3 id="the-standard-lorem-ipsum-passage-used-since-the-1500s">The standard Lorem Ipsum passage, used since the 1500s</h3>
<p>“Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.”</p>


  <p class="text-left"><a href="/testtest">Continue Reading &rarr;</a></p>
</div>

<div class="post-header-home">
  <h1>
    <a href="/introducing-autm-rb">Autm-rb: A Bootstrap-Based Jekyll Theme</a>
  </h1>
  <p class="text-muted">30 Nov 2014 | <i class="fa fa-comment"></i> <a class="text-muted" href="/introducing-autm-rb/#disqus_thread"></a> | <i class="fa fa-tag"></i>
  
    
  
  
  <a class="text-muted" href="/tags/#Autm-rb">Autm-rb</a>,
  
  <a class="text-muted" href="/tags/#download">download</a>
  


 </p>

</div>
<div class="post-excerpt-home">
  <p><img src="http://scontent-a.cdninstagram.com/hphotos-xpa1/t51.2885-15/10561076_278209769029508_1423568667_n.jpg" alt="Autumn-rb" /></p>


  <p class="text-left"><a href="/introducing-autm-rb">Continue Reading &rarr;</a></p>
</div>


<div class="paginate" >

  
    <span></span>
  
  
  
    
      <em>1</em>
    
  
    
      <a href="/blog/page2">2</a>
    
  

  
    <a href="/blog/page2"><i class="fa fa-chevron-right"></i></a>
  


</div>
 

          <footer>
<hr/>
  <div class="left">  
    &copy;2015.
    Built with <a href="http://jekyllrb.com/">Jekyll</a> and
    <a href="https://github.com/492066199/492066199.github.io">492066199</a>
  </div>

  <div class="right">
    
      <a href="https://twitter.com/railsr7"><i class="fa fa-twitter fa-lg" style="color:#49B1F7;"></i></a>
    </a>
    
  </div>
</footer>

        </section>
    </div>   
    </div>
    <script src="/public/javascripts/jquery.min.js"></script>
    <script src="/public/javascripts/bootstrap.min.js"></script>
    <!-- Place your <script> tags here. -->

<!-- disqus comment counter -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yang';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function () {
	    var s = document.createElement('script'); s.async = true;
	    s.type = 'text/javascript';
	    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
	    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
	}());
</script>
<!-- /disqus comment counter -->
		
		
		
<!-- google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
<!-- /google analytics -->

  </body>
</html>
