<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/public/stylesheets/bs.css">
    <link rel="stylesheet" href="/public/stylesheets/styles.css">
    <link rel="stylesheet" href="/public/stylesheets/pygment_trac.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"> 
    <link rel="canonical" href="www.yangsailing.com/nginx">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <link rel="icon" type="image/x-icon"  href="/favicon.ico" />
    <title>nginx源码分析2———基础数据结构六(ngx_hash_keys_arrays_t） | Romeo'blog</title>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head> 
  <body>
    <div class="wrapper">    
        <section>   
          <div id="title">
  <h1>
    
		  <a id="git-ic" href="https://github.com/492066199"><i class="fa fa-github"></i></a>	
    

    
      <a id="so-ic" href="http://stackoverflow.com/users/1231365/railsr"><i class="fa fa-stack-overflow"></i></a>
    
		
    <a id="sitename" href="">www.yangsailing.com</a>
  </h1>

  <!-- Add something about you in p tag-->
  <p>本博客长期专注软件开发基本功，Linux平台基础开源(nginx, redis, memcached)软件分析、研究，高级数据结构与算法详解，大数据(kafka，Samza，hadoop)相关原理剖析，欢迎不涩指点</p>
  <hr/>
  
  <span class="credits left">
  <a href="/blog">Blog</a> | 
  <a href="/archive">Archive</a> |
  <a href="/resume">Resume</a> |
  <a href="/projects">Projects</a> 
</span>

<span class="credits right">

</span> 
	 
</div>



      
          <div class="post-title">
    <h1>nginx源码分析2———基础数据结构六(ngx_hash_keys_arrays_t）</h1>
    <p class="text-muted">11 Aug 2015 | <i class="fa fa-tag"></i>
  
    
  
  
  <a class="text-muted" href="/tags/#nginx">nginx</a>,
  
  <a class="text-muted" href="/tags/#ngx_hash_keys_arrays_t）">ngx_hash_keys_arrays_t）</a>
  


</p>

</div>
            
  <h3 id="section">相关介绍</h3>
<p><strong><em>在构建一个ngx_hash_wildcard_t的时候，需要对通配符的哪些key进行预处理。这个处理起来比较麻烦</em></strong>。而当有一组key，这些里面既有无通配符的
key，也有包含通配符的key的时候。我们就需要构建三个hash表，一个包含普通的key的hash表，一个包含前向通配符的hash表，一个包含后向通配符的hash
表（或者也可以把这三个hash表组合成一个ngx_hash_combined_t）。在这种情况下，为了让大家方便的构造这些hash表，nginx提供给了此辅助类型。有了
这个就可以清晰了解上一篇博文
###源码分析
####相关结构
ngx_hash_keys_arrays_t就是我们说的辅助结构，辅助我们更容易去构建<strong><em>ngx_hash_wildcard_t</em></strong>
<code>c
typedef struct {
    ngx_uint_t        hsize;
    ngx_pool_t       *pool;
    ngx_pool_t       *temp_pool;
    ngx_array_t       keys;
    ngx_array_t      *keys_hash;
    ngx_array_t       dns_wc_head;
    ngx_array_t      *dns_wc_head_hash;
    ngx_array_t       dns_wc_tail;
    ngx_array_t      *dns_wc_tail_hash;
} ngx_hash_keys_arrays_t;
</code>
<strong><em>hsize</em></strong>是我们将要构建的hash表的桶的个数
<strong><em>pool</em></strong> 构建hash表使用的pool
<strong><em>temp_pool</em></strong>在构建这个类型以及最终的三个hash表过程中可能用到临时pool
<strong><em>keys</em></strong>存放所有非通配符key的数组
<strong><em>keys_hash</em></strong>这是个二维数组，第一个维度代表的是bucket的编号，那么keys_hash[i]中存放的是所有的key算出来的hash值对hsize取模以后的值为i
的key
<strong><em>dns_wc_head</em></strong>放前向通配符key被处理完成以后的值
<strong><em>dns_wc_tail</em></strong>存放后向通配符key被处理完成以后的值
<strong><em>dns_wc_head_hash</em></strong>该值在调用的过程中用来保存和检测是否有冲突的前向通配符的key值，<strong><em>也就是是否有重复</em></strong>
<strong><em>dns_wc_tail_hash</em></strong>该值在调用的过程中用来保存和检测是否有冲突的后向通配符的key值，<strong><em>也就是是否有重复</em></strong>
####结构的初始化
```c
ngx_int_t
ngx_hash_keys_array_init(ngx_hash_keys_arrays_t *ha, ngx_uint_t type)
{
    ngx_uint_t  asize;
	//根据type来选择是大号桶的个数还是小号桶的个数
    if (type == NGX_HASH_SMALL) {
        asize = 4;
        ha-&gt;hsize = 107;
    } else {
        asize = NGX_HASH_LARGE_ASIZE;
        ha-&gt;hsize = NGX_HASH_LARGE_HSIZE;
    }</p>

<pre><code>//初始化非通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;keys, ha-&gt;temp_pool, asize, sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化头部有通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;dns_wc_head, ha-&gt;temp_pool, asize,sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化尾部有通配符的keys数组，数组容量为asize
if (ngx_array_init(&amp;ha-&gt;dns_wc_tail, ha-&gt;temp_pool, asize, sizeof(ngx_hash_key_t))
    != NGX_OK)
{
    return NGX_ERROR;
}
//初始化二维数组keys_hash
ha-&gt;keys_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;keys_hash == NULL) {
    return NGX_ERROR;
}
//初始化头部通配符冲突检测
ha-&gt;dns_wc_head_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;dns_wc_head_hash == NULL) {
    return NGX_ERROR;
}
//初始化尾部通配符冲突检测
ha-&gt;dns_wc_tail_hash = ngx_pcalloc(ha-&gt;temp_pool, sizeof(ngx_array_t) * ha-&gt;hsize);
if (ha-&gt;dns_wc_tail_hash == NULL) {
    return NGX_ERROR;
}
return NGX_OK; } ``` ***ngx_hash_keys_array_init***初始化操作。都是一系列分配内存操作。下面我们来看一看ngx_hash_add_key操作。 ```c ngx_int_t ngx_hash_add_key(ngx_hash_keys_arrays_t *ha, ngx_str_t *key, void *value,ngx_uint_t flags) {
size_t           len;
u_char          *p;
ngx_str_t       *name;
ngx_uint_t       i, k, n, skip, last;
ngx_array_t     *keys, *hwc;
ngx_hash_key_t  *hk;

last = key-&gt;len;

if (flags &amp; NGX_HASH_WILDCARD_KEY) {
    /*
     * supported wildcards:
     *     "*.example.com", ".example.com", and "www.example.*"
     */

    n = 0;

    for (i = 0; i &lt; key-&gt;len; i++) {
		//如果含有两个*，就return不处理
        if (key-&gt;data[i] == '*') {
            if (++n &gt; 1) {
                return NGX_DECLINED;
            }
        }
		
		//如果有挨着的两个点也不处理
        if (key-&gt;data[i] == '.' &amp;&amp; key-&gt;data[i + 1] == '.') {
            return NGX_DECLINED;
        }
    }
    //skip是前省略的，last为后面省略的		
	//如果是'.example.com'
    if (key-&gt;len &gt; 1 &amp;&amp; key-&gt;data[0] == '.') {
        skip = 1;
        goto wildcard;
    }
    if (key-&gt;len &gt; 2) 
    {
        //如果是'*.example.com'
        if (key-&gt;data[0] == '*' &amp;&amp; key-&gt;data[1] == '.') 
        {
            skip = 2;
            goto wildcard;
        }
		//'www.example.*'
        if (key-&gt;data[i - 2] == '.' &amp;&amp; key-&gt;data[i - 1] == '*')
         {
            skip = 0;
            last -= 2;
            goto wildcard;
        }
    }

	//如果含有*就不能当做exact hash处理了
    if (n) {
        return NGX_DECLINED;
    }
}

/* exact hash */
//处理精确hash查找的key
k = 0;

//计算hashcode
for (i = 0; i &lt; last; i++) {
    if (!(flags &amp; NGX_HASH_READONLY_KEY)) {
        key-&gt;data[i] = ngx_tolower(key-&gt;data[i]);
    }
    k = ngx_hash(k, key-&gt;data[i]);
}

k %= ha-&gt;hsize;

/* check conflicts in exact hash */

name = ha-&gt;keys_hash[k].elts;
//查看是否冲突
if (name) {
    for (i = 0; i &lt; ha-&gt;keys_hash[k].nelts; i++) 
    {
        if (last != name[i].len) {
            continue;
        }

        if (ngx_strncmp(key-&gt;data, name[i].data, last) == 0)
        {
            return NGX_BUSY;
        }
    }
} else {
    if (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, 4,
                       sizeof(ngx_str_t))
        != NGX_OK)
    {
        return NGX_ERROR;
    }
}

name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);
if (name == NULL) {
    return NGX_ERROR;
}

*name = *key;

hk = ngx_array_push(&amp;ha-&gt;keys);
if (hk == NULL) {
    return NGX_ERROR;
}

hk-&gt;key = *key;
hk-&gt;key_hash = ngx_hash_key(key-&gt;data, last);
hk-&gt;value = value;

return NGX_OK;
</code></pre>

<p>wildcard:</p>

<pre><code>/* wildcard hash */
//根据skip和last截断后计算hashcode
k = ngx_hash_strlow(&amp;key-&gt;data[skip], &amp;key-&gt;data[skip], last - skip);
k %= ha-&gt;hsize;
//处理'.example.com'
if (skip == 1) {
    /* check conflicts in exact hash for ".example.com" */

    name = ha-&gt;keys_hash[k].elts;
	//在key_hash中寻找，看是否有重复
    if (name) {
        //长度为去掉头与尾
        len = last - skip;
        for (i = 0; i &lt; ha-&gt;keys_hash[k].nelts; i++) 
        {
            if (len != name[i].len) {
                continue;
            }
			
            if (ngx_strncmp(&amp;key-&gt;data[1], name[i].data, len) == 0) 
            {
                return NGX_BUSY;
            }
        }
    } else {
    //没有救初始化数组，将该元素放进去
        if (ngx_array_init(&amp;ha-&gt;keys_hash[k], ha-&gt;temp_pool, 4,sizeof(ngx_str_t)) != NGX_OK)
        {
            return NGX_ERROR;
        }
    }

    name = ngx_array_push(&amp;ha-&gt;keys_hash[k]);
    if (name == NULL) {
        return NGX_ERROR;
    }
	//长度为last减1  只放入点前面的
    name-&gt;len = last - 1;
    name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);
    if (name-&gt;data == NULL) {
        return NGX_ERROR;
    }
	//拷贝过去。算是深拷贝
    ngx_memcpy(name-&gt;data, &amp;key-&gt;data[1], name-&gt;len);
}

if (skip) {

    /*
     * convert "*.example.com" to "com.example.\0"
     *      and ".example.com" to "com.example\0"
     */
	//对	*.example.com与.example.com做反转处理
    p = ngx_pnalloc(ha-&gt;temp_pool, last);
    if (p == NULL) {
        return NGX_ERROR;
    }
	重置n与len
    len = 0;
    n = 0;
	
	//反转  将*.example.com处理为.example.com
	//     将.example.com处理为.com
    for (i = last - 1; i; i--) {
        if (key-&gt;data[i] == '.') {
            ngx_memcpy(&amp;p[n], &amp;key-&gt;data[i + 1], len);
            n += len;
            p[n++] = '.';
            len = 0;
            continue;
        }
        len++;
    }
 		//     将.com处理为example.com
    if (len) {
        ngx_memcpy(&amp;p[n], &amp;key-&gt;data[1], len);
        n += len;
    }
	
	//p是普通字符串，在最后补0
    p[n] = '\0';

    hwc = &amp;ha-&gt;dns_wc_head;
    keys = &amp;ha-&gt;dns_wc_head_hash[k];
} else {
    /* convert "www.example.*" to "www.example\0" */

    last++;
	//处理后置通配符
    p = ngx_pnalloc(ha-&gt;temp_pool, last);
    if (p == NULL) {
        return NGX_ERROR;
    }
	//直接拷贝www.example.到p，由于last的长度限制
	//会把最后一个.变成0(详见ngx_cpystrn函数)
    ngx_cpystrn(p, key-&gt;data, last);
	//最后p为'www.example\0'
	
    hwc = &amp;ha-&gt;dns_wc_tail;
    keys = &amp;ha-&gt;dns_wc_tail_hash[k];
}

/* check conflicts in wildcard hash */
//处理是否有冲突
name = keys-&gt;elts;

if (name) {
    //注意后面有通配符的的last有+1，所以len会以.结尾
    //前置通配符会去掉skip的字符
    len = last - skip;
    //查看是否有重复
    for (i = 0; i &lt; keys-&gt;nelts; i++) {
        if (len != name[i].len) {
            continue;
        }

        if (ngx_strncmp(key-&gt;data + skip, name[i].data, len) == 0) {
            return NGX_BUSY;
        }
    }
} else {
    if (ngx_array_init(keys, ha-&gt;temp_pool, 4, sizeof(ngx_str_t)) != NGX_OK)
    {
        return NGX_ERROR;
    }
}
//没有重复就放进去
name = ngx_array_push(keys);
if (name == NULL) {
    return NGX_ERROR;
}
//长度和刚才比较所用的长度相同
name-&gt;len = last - skip;
name-&gt;data = ngx_pnalloc(ha-&gt;temp_pool, name-&gt;len);
if (name-&gt;data == NULL) {
    return NGX_ERROR;
}

ngx_memcpy(name-&gt;data, key-&gt;data + skip, name-&gt;len);


/* add to wildcard hash */
//假如hash keys里面去，以便初始化通配符字符串
hk = ngx_array_push(hwc);
if (hk == NULL) {
    return NGX_ERROR;
}
//注意长度为last - 1
//也就是前置会减去一个字符
//后置减去两个
hk-&gt;key.len = last - 1;
hk-&gt;key.data = p;
hk-&gt;key_hash = 0;
hk-&gt;value = value;

return NGX_OK; } ``` 最后说一下本文的例子 ```c *.test.com    --------&gt;  com.test. .test.com     --------&gt;  com.test yang.test.*	  --------&gt;  yang.test ``` ###总结 把本节与上一节联系起来，就会感觉特别清晰。本节中的key都主要用于初始化，和以后的查找通配符hash表。
</code></pre>

    
<div class="share-btns">
  
 <h4>Share this post:</h4>


 
<a class="btn btn-small btn-sm twitter" href="http://twitter.com/share?text=nginx源码分析2———基础数据结构六(ngx_hash_keys_arrays_t）"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>

        <a class="btn btn-small btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>

        <a class="btn btn-small btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
 </a>

</div>   

<div class="comments">
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'yang';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</div> 

<div class="post-footer">
  
</div>
<hr/>


  
    <div class="post-navs row">
      
        <div class="col-md-6 post-nav">
            
          <h3 class="section-header">
            Older
            <span class="text-muted"> &middot; </span>
            <a href="/archive">View Archive (4)</a>
          </h3>
            
          <h2 class="post-title-link"><a href="/testtest">Test post</a></h2>
          <h3 id="the-standard-lorem-ipsum-passage-used-since-the-1500s">The standard Lorem Ipsum passage, used since the 1500s</h3>
<p>“Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.”</p>


        </div>
      
      
    </div>
  

 

          <footer>
<hr/>
  <div class="left">  
    &copy;2015.
    Built with <a href="http://jekyllrb.com/">Jekyll</a> and
    <a href="https://github.com/492066199/492066199.github.io">492066199</a>
  </div>

  <div class="right">
    
      <a href="https://twitter.com/railsr7"><i class="fa fa-twitter fa-lg" style="color:#49B1F7;"></i></a>
    </a>
    
  </div>
</footer>

        </section>
    </div>   
    </div>
    <script src="/public/javascripts/jquery.min.js"></script>
    <script src="/public/javascripts/bootstrap.min.js"></script>
    <!-- Place your <script> tags here. -->

<!-- disqus comment counter -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yang';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function () {
	    var s = document.createElement('script'); s.async = true;
	    s.type = 'text/javascript';
	    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
	    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
	}());
</script>
<!-- /disqus comment counter -->
		
		
		
<!-- google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
<!-- /google analytics -->

  </body>
</html>
